## 4장 외부 연동이 문제일 때 살펴봐야 할 것들

## 타임아웃
- 외부 연동에서 가장 중요한 설정 중 하나는 타임아웃이다.
- 타임아웃은 응답 시간과 깊이 관려되어 있다.
- 연동 서비스를 호출할 때 타임아웃을 적절히 설정하지 않으면, 연동 서비스에 장애가 발생했을 때 전체 서비스의 품질이 급격히 나빠질 수 있다.


- 처음 연동하는 서비스라면
  - 연결 타임아웃: 3초 ~ 5초
  - 읽기 타임아웃: 5초 ~ 30초
- 정도로 설정하고 추이를 보면서 조정하는 것이 좋다.
- 타임아웃이 너무 짧으면 연동 서비스가 정상 처리했음에도 불구하고 타임아웃 에러가 발생할 수 있다.


## 재시도
- 외부 연동에 실패했을 때 처리 방법 중 하나는 재시도를 하는 것이다.
- 네트워크 통신 과정에서 간헐적으로 연결에 실패하거나 일시적으로 응답이 느려지는 경우가 있다.
  - 이럴 때는 재시도를 통해 연동 실패를 성공으로 바꿀 수 있다.


### 재시도 가능 조건
- 항상 재시도를 할 수 있는 것은 아니며,
- 먼저 연동 API를 다시 호출해도 되는 조건인지 확인해야 한다.
- 상태를 변경하는 연동 API를 재시도할 때는 멱등성을 고려해야 한다.


### 재시도 횟수와 간격
- 재시도를 무한정 할 수는 없다.
- 재시도 횟수만큼 응답 시간도 함께 증가하기 때문이다.
- 대부분의 경우 1 ~ 2회 정도의 재시도가 적당하다.
- 재시도 간격도 중요하다.
- 네트워크 연결 상태가 좋지 않은 상황을 가정해볼 때
- 약간의 간격을 두고 재시도하면 일시적인 네트워크 문제가 해소되면서 재시도가 성공할 가능성이 높아진다.
- 여러 차례 재시도할 때는 재시도 간격을 점진적으로 늘리기도 한다.
  - ex: 1번 째 재시도 1초 뒤에, 2번째 재시도 2초 뒤에...


### 재시도 폭풍 (retry storm) 안티패턴
- 재시도를 통해 성공 가능성을 높일 수 있지만, 반대로 연동 서비스에는 더 큰 부하를 줄 수 있다.
- 재시도를 검토할 때는 연동 서비스의 성능 상황도 함께 고려해야 한다.


## 동시 요청 제한
- 연동 서비스에 임계치 이상의 요청을 보내면서 발생하는 성능 저하 문제를 완화하는 방법은, 연동 서비스에서 요청을 일정 수준 이상으로 보내지 않는 것이다.

```markdown
벌크헤드(bulkhead)

각 구성 요소를 격리함으로써 한 구성 요소의 장애가 다른 구성 요소에 영향을 주지 않도록 하는 설계 패턴이다.
```


## 서킷 브레이커
- 서킷 브레이커는 누전 차단기와 비슷하게 동작한다.
- 서킷 브레이커는 닫힘, 열림, 반 열림의 3가지 상태를 갖는다.
- 서킷 브레이커는 닫힘 상태에서 시작한다.
  - 닫힘 상태일 때는 모든 요청을 연동 서비스에 전달한다.
- 외부 연동 과정에서 오류가 발생하기 시작하면, 지정한 임계치를 초과했는지 확인한다.
- 실패 건수가 임계치를 초과하면 서킷 브레이커는 열림 상태가 된다.
  - 열림 상태가 되면 연동 요청을 수행하지 않고, 바로 에러 응답을 리턴한다.
- 열림 상태는 지정된 시간 동안 유지된다.
- 이 시간이 지나면 반 열림 상태가 된다.
  - 반 열림 상태가 되면 일부 요청에 한해 연동을 시도한다.
  - 일정 개수 또는 일정 시간 동안 반 열림 상태를 유지하며, 이 기간 동안 연동에 성공하면 닫힘 상태로 복귀한다.
  - 반대로 연동에 실패하면 다시 열림 상태로 전환되어 연동을 차단한다.

```markdown
빠른 실패 (fast failure)

서킷 브레이커는 문제 상황이 감지되면 해당 기능을 더 이상 실행하지 않고 바로 실패로 처리한다.
이처럼 실패를 빠르게 감지하고, 문제가 있는 기능을 실행하지 않고 중단시키는 방식을 빠른 실패라고 한다.

빠른 실패는 장애가 발생한 기능에 부하가 더해지는 것을 방지할 뿐 아니라, 불필요한 자원 낭비를 줄여 전체 서비스의 안정성을 유지하는 데도 도움이 된다.
```


## 외부 연동과 DB 연동

### 외부 연동과 트랜잭션 처리
- DB 연동과 외부 연동을 함께 실행할 때는, 오류 발생 시 DB 트랜잭션을 어떻게 처리할지 알맞게 판단해야 한다.
  - 외부 연동에 실패했을 때 트랜잭션 롤백
  - 외부 연동은 성공했지만 DB 연동에 실패해 트랜잭션 롤백

### 외부 연동이 느려질 때 DB 커넥션 풀 문제
- DB 연동과 무관하게 외부 연동을 실행할 수 있다면, DB 커넥션을 사용하기 전이나 후에 외부 연동을 시도하는 방안도 고려해볼 수 있다.
- 이렇게 하면 외부 연동 시간이 길어지더라도 DB 커넥션 풀이 포화되는 상황을 방지할 수 있다.


### HTTP 커넥션 풀
- DB 커넥션 풀이 DB 연결에 걸리는 시간을 줄여 성능을 높이는 것처럼 HTTP 연결도 커넥션 풀을 사용하면 연결 시간을 줄일 수 있어 응답 속도에 향상에 도움이 된다.
- HTTP 커넥션 풀을 사용할 때는 다음 3가지를 고려해야 한다.
  - HTTP 커넥션 풀 크기
  - 풀에서 HTTP 커넥션을 가져올 때까지 대기하는 시간
  - HTTP 커넥션을 유지할 시간 (keep alive)


## 연동 서비스 이중화
- 서비스가 대량 트래픽을 처리할 만큼 성장했다면 연동 서비스의 이중화를 고려해야 한다.
- 물론 연동 기능을 이중화하면 연동할 서비스가 늘어나고 그만큼 개발과 유지에 드는 비용도 증가한다.
- 그래서 연동 서비스를 이중화할지 여부를 결정할 때는 다음 2가지를 반드시 따져봐야 한다.
  - 해당 기능이 서비스의 핵심인지 여부
  - 이중화 비용이 감당 가능한 수준인지
- 또한 재정적으로 이중화를 감당할 수 있어야 한다.
