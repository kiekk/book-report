### rewrite 모듈

```
rewrite 모듈은 URI를 재작성하는 것이 목적입니다.
URI rewrite는 검색 엔진 최적화의 핵심 요소입니다.
클라이언트 요청이 수신된 후 파일을 제공하기 전에 요청 URI를 재작성합니다.
재작성하고 나면 재작성된 URI를 location 블록과 비교하면서 해당 요청에 적용할 서버 구성을 찾습니다.
```

`rewrite 모듈은 정규식을 어느 정도 이해해야 사용할 수 있습니다.`
[정규식.md](%EC%A0%95%EA%B7%9C%EC%8B%9D.md)

#### 내부 요청
```
엔진엑스에서는 외부 요청과 내부 요청을 구분합니다.
외부 요청은 클라이언트에서 직접 온 요청입니다.
내부 요청은 엔진엑스에서 특수한 지시어에 의해 발생합니다.
내부 요청은 다음 두 가지 유형으로 나뉩니다.
```
- 내부 경로 재설정
  - 엔진엑스는 클라이언트 요청을 내부에서 경로를 변경해 처리합니다.
  - 원래 URI가 바뀌기 때문에 이 요청은 다른 location 블록에 부합하는 것으로 판단되도록 다른 설정이 적용됩니다.
  - 내부 요청이 쓰이는 가장 일반적인 경우는 rewrite 지시어가 쓰일 때입니다.
  - rewrite 지시어는 요청 URI를 재작성합니다.
- 부가 요청
  - 원래 요청을 보완할 내용을 생성하고자 내부에서 추가로 새로 만들어지는 요청이 있습니다.
  - 이렇게 생성된 내부 요청의 결과는 원래 요청의 본문 뒤에 첨가됩니다.

#### error_page
```
error_page는 특정 오류 코드가 발생했을 때 서버의 행위를 정의합니다.
```

```
server {
    server_name website.com;
    error_page 403 /errors/forbidden.html;
    error_page 404 /errors/not_found.html;
    
    location /errors/ {
        alias /var/www/common/errors/;
        internal;
    }
}
```

#### rewrite
```
error_page 지시어가 다른 위치로 경로를 재설정하는 방식과 비슷하게 rewrite 지시어로 URI를 재작성하면 내부 경로 재설정이 일어납니다.
```

```
server {
    server_name website.com;
    root /var/www/vhosts/website.com/httpdocs/;
    location /storage/ {
        internal;
        alias /var/www/storage/;
    }
    location /documents/ {
        rewrite ^/documents/(.*)$ /storage/$1;   
    }
}
```


#### 무한 루프
```
재작성 규칙이 과하면 내부 경로 재설정이 무한 반복되는 루프에 빠지는 경우가 있습니다.
```

```
server {
    server_name website.com;
    location /documents/ {
        rewrite ^(.*)$ /documents/$1;
    }
}
```

### 조건부 구조
```
rewrite 모듈에서 제공하는 새로운 지시어와 블록 중에는 if 조건부 구조도 있습니다.
```

```
server {
    if ($request_method = POST) {
        [...]
    }
}
```

| 연산자            | 설명                                                                                                         |
|----------------|------------------------------------------------------------------------------------------------------------|
| None 없음        | 지정된 변수나 데이터가 빈 문자열이거나 0이 아니라면 조건은 참입니다.                                                                    |
| =, !=          | =에 앞선 인자와 뒤따르는 인자가 같으면 이 조건은 참입니다.<br/>!=는 반대로 동작합니다.                                                      |
| ~, ~*, !~, !~* | ~ 기호에 선행하는 인자가 그 다음에 오는 정규식 패턴과 일치하면 이 조건은 참입니다.<br/>~는 대소문자를 구분하지만 ~*는 구분하지 않습니다.<br/>!~, !~*는 반대로 동작합니다. |
| -f, !-f        | 지정된 파일이 있는지 확인합니다.<br/>!-f는 파일이 없는지 확인합니다.                                                                 |
|-d, !-d| 디렉터리가 있는지 확인합니다.                                                                                           |
|-e, !-e| 파일, 디렉터리, 심볼릭 링크가 있는지 확인합니다.                                                                               |
|-x, !-x| 파일이 있고, 실행 가능한지 확인합니다.                                                                                     |
